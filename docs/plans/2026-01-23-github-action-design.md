# Figma VEX GitHub Action Design

## Overview

A GitHub Action that receives design token exports from the Figma VEX plugin (via repository dispatch), writes them to configured file paths, and creates or updates a pull request.

## Action Definition

**Location:** `action.yml` at repository root
**Usage:** `uses: andyhite/figma-vex@v1`

### Inputs

| Input             | Required | Default                                  | Description                                |
| ----------------- | -------- | ---------------------------------------- | ------------------------------------------ |
| `token`           | No       | `${{ github.token }}`                    | GitHub token for creating branches and PRs |
| `base-branch`     | No       | Repo default                             | Target branch for the PR                   |
| `pr-title`        | No       | `chore: update design tokens from figma` | PR title and commit message                |
| `css-path`        | No       | -                                        | Path to write CSS variables                |
| `scss-path`       | No       | -                                        | Path to write SCSS variables               |
| `json-path`       | No       | -                                        | Path to write JSON tokens                  |
| `typescript-path` | No       | -                                        | Path to write TypeScript definitions       |

At least one `*-path` input must be provided.

### Outputs

| Output      | Description                                                  |
| ----------- | ------------------------------------------------------------ |
| `pr-url`    | URL of the created or updated pull request                   |
| `pr-number` | Number of the created or updated pull request                |
| `branch`    | Name of the branch used                                      |
| `updated`   | `true` if existing PR was updated, `false` if new PR created |

## Workflow Usage

```yaml
name: Update Design Tokens
on:
  repository_dispatch:
    types: [figma-variables-update]

jobs:
  update-tokens:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: andyhite/figma-vex@v1
        id: vex
        with:
          css-path: src/styles/variables.css
          scss-path: src/styles/_variables.scss
          json-path: tokens/tokens.json
          typescript-path: src/types/variables.d.ts

      - run: echo "PR created at ${{ steps.vex.outputs.pr-url }}"
```

## Core Logic

### Step 1: Validate Inputs

- Ensure at least one `*-path` input is provided
- Verify the event is `repository_dispatch` with expected payload structure
- Fail fast with clear error messages if validation fails

### Step 2: Find or Create Branch

- Search for open PRs where head branch starts with `figma-vex/`
- If found: checkout that existing branch
- If not found: create new branch `figma-vex/update-{github.run_id}` from base branch

### Step 3: Write Files

- For each provided path input, write the corresponding export from `client_payload.exports`
- Create parent directories if they don't exist
- Only write files for paths that were specified

### Step 4: Commit and Push

- Stage all changed files
- Commit with configured title as message
- Push to the branch (force push if updating existing)

### Step 5: Create or Update PR

- If new branch: create PR with title, detailed body, targeting base branch
- If existing branch: update PR body with new timestamp/file list

### Step 6: Set Outputs

- Expose `pr-url`, `pr-number`, `branch`, `updated` for downstream steps

## PR Body Format

```markdown
## Figma Variables Update

Updated from **{figma_file}** on {formatted_date}

### Files updated

- `src/styles/variables.css`
- `tokens/tokens.json`

---

_Auto-generated by [Figma VEX](https://github.com/andyhite/figma-vex)_
```

## File Structure

```
figma-vex/
├── action.yml                    # Action definition
├── dist/                         # Compiled action (committed)
│   └── index.js
├── src/
│   ├── plugin/                   # Existing plugin code
│   ├── ui/                       # Existing UI code
│   ├── shared/                   # Existing shared types
│   └── action/                   # Action source code
│       ├── index.ts              # Entry point
│       ├── github.ts             # PR/branch operations
│       ├── files.ts              # File writing logic
│       └── types.ts              # Action-specific types
├── package.json                  # Add @actions/core, @actions/github
└── tsconfig.action.json          # Separate config for action build
```

## Dependencies

```json
{
  "@actions/core": "^1.10.0",
  "@actions/github": "^6.0.0"
}
```

## Build Process

- Use `esbuild` to bundle action code to `dist/index.js`
- Target Node 20 (current GitHub Actions runner)
- Add npm script: `build:action`
- Commit `dist/` on release branches/tags

## Release Strategy

- Tag releases as `v1`, `v1.0.0`, etc.
- Keep `v1` tag updated to latest `v1.x.x` for users who want auto-updates
- `dist/` committed on release branches/tags

## Token Permissions

The action works with either:

- `GITHUB_TOKEN` (automatic, but PRs won't trigger other workflows)
- Personal Access Token (for PRs that need to trigger CI)

Required permissions: `contents: write`, `pull-requests: write`
