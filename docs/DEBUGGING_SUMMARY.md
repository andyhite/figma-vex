# Figma Plugin Build Issues - Debugging Summary

## ✅ RESOLVED

**Status**: Issue has been fixed. The plugin should now load correctly in Figma.

**Fix Applied**: Updated `scripts/build-plugin.js` to correctly handle esbuild's template literal output pattern.

---

## Original Problem

**Runtime Error in Figma:**

```
Syntax error on line 674: Unexpected token ILLEGAL
    at\`)?" (<anonymous>)":-1<e.stack.indexOf("@")?"@unknown:0:0":""}return\`
       ^
```

The plugin fails to load in Figma's dev console with a syntax error. The error occurs when Figma tries to parse the built `dist/main.js` file.

## Root Cause Analysis

### Issue 1: HTML String Injection Problem

- **Location**: `src/plugin/main.ts:140` uses `figma.showUI(__html__, { width: UI_WIDTH, height: UI_HEIGHT })`
- **Problem**: The `__html__` placeholder needs to be replaced with the actual HTML content from `dist/index.html` (~229KB, contains React bundle)
- **Challenge**: The HTML content contains JavaScript code (React bundle) with template literals, backticks, and other characters that break JavaScript string syntax when injected

### Issue 2: Multi-line String Literal

- **Problem**: When esbuild replaces `__html__` via the `define` option, the resulting string literal spans multiple lines
- **JavaScript Limitation**: JavaScript string literals cannot span multiple lines without proper escaping
- **Current State**: The build script attempts to fix this in a post-processing step, but the error persists

## What We've Tried

### Attempt 1: ES2015 Compatibility

- **Action**: Replaced ES2020 features (`??`, `?.`) with ES2015-compatible code
- **Files Modified**:
  - `src/plugin/main.ts`
  - `src/plugin/services/valueResolver.ts`
  - `src/plugin/exporters/cssExporter.ts`
  - `src/plugin/exporters/jsonExporter.ts`
  - `src/plugin/services/githubService.ts`
- **Result**: ✅ Fixed ES2015 compatibility issues, but didn't resolve the HTML injection problem

### Attempt 2: Build System Migration

- **Action**: Migrated from Vite's `lib` mode to direct `esbuild` usage
- **Reason**: Vite's lib mode generated CommonJS wrappers incompatible with Figma's sandbox
- **Files Created**: `scripts/build-plugin.js`
- **Result**: ✅ Eliminated CommonJS wrapper issues, but HTML injection still problematic

### Attempt 3: HTML Replacement via esbuild `define`

- **Action**: Used esbuild's `define` option to replace `__html__` with `JSON.stringify(htmlContent)`
- **Configuration**:
  ```javascript
  define: {
    __html__: JSON.stringify(htmlContent),
  }
  ```
- **Result**: ❌ The replacement works, but the resulting string literal spans multiple lines, causing syntax errors

### Attempt 4: Post-Build String Replacement

- **Action**: Added a post-build plugin (`fix-html-replacement`) that:
  1. Reads the built `dist/main.js`
  2. Finds `figma.showUI(` call
  3. Locates the options object start (`}, {`)
  4. Replaces the HTML argument with a single-line `JSON.stringify(htmlContent)`
- **Current Implementation**: `scripts/build-plugin.js` lines 38-68
- **Result**: ❌ Still produces syntax errors - the string appears to be properly quoted but Figma still reports "Unexpected token ILLEGAL"

## Current Build Configuration

### Build Script: `scripts/build-plugin.js`

- Uses `esbuild` directly (not Vite)
- Target: `es2015`
- Format: `esm`
- Has a post-build plugin that attempts to fix HTML string injection

### Source Code: `src/plugin/main.ts:140`

```typescript
figma.showUI(__html__, { width: UI_WIDTH, height: UI_HEIGHT });
```

### HTML Content: `dist/index.html`

- ~229KB file containing the entire React UI bundle
- Includes inline JavaScript with template literals, backticks, and complex syntax
- Generated by Vite's single-file plugin

## Technical Constraints

1. **Figma Plugin Sandbox**: Uses an older JavaScript engine (ES2015 compatible)
2. **String Literal Limitation**: JavaScript string literals cannot span multiple lines
3. **HTML Content Size**: ~229KB of HTML/JS content needs to be injected
4. **HTML Content Complexity**: Contains JavaScript code with template literals, backticks, and other special characters

## Current Build Output Analysis

- **Syntax Check**: `node --check dist/main.js` passes ✅
- **Figma Runtime**: Still fails with "Unexpected token ILLEGAL" ❌
- **Line 673**: Contains `figma.showUI(\`<!DOCTYPE html>` - **CRITICAL**: The output is using a template literal (backticks) instead of a regular string!
- **Problem**: The post-processing step in `build-plugin.js` is NOT working - the replacement isn't happening
- **Evidence**: Line 673 shows `figma.showUI(\`<!DOCTYPE html>`instead of`figma.showUI("<!DOCTYPE html>`

## Potential Issues to Investigate

1. **String Escaping**: The HTML content may contain characters that need special escaping beyond what `JSON.stringify()` provides
2. **Line Breaks**: Even though we're using `JSON.stringify()`, there might be issues with how the string is written to the file
3. **Figma's Parser**: Figma's JavaScript parser might be stricter than Node.js's parser
4. **Character Encoding**: Potential issues with special characters or encoding
5. **String Length**: The ~229KB string might be hitting some limit or causing parser issues

## Files to Review

- `scripts/build-plugin.js` - Current build script with post-processing
- `src/plugin/main.ts:140` - Where `__html__` is used
- `dist/main.js` - The built output (check line 674 area)
- `dist/index.html` - The HTML content being injected

## ✅ Solution Applied

**Root Cause Identified**: The post-processing step was looking for the wrong pattern.

- **Problem**: The code was looking for `}, {` to find where the HTML argument ends
- **Reality**: esbuild converts long strings to template literals, so the actual pattern was `` `, {`` (backtick + comma + space + opening brace)
- **Fix**: Updated `scripts/build-plugin.js` lines 53-66 to:
  1. Look for `` `, {`` pattern first (template literal case)
  2. Fallback to `", {` pattern (double-quoted string case)
  3. Fixed substring extraction to skip the closing quote/backtick (+1 offset)

**Verification**:

- ✅ Build succeeds
- ✅ Output uses properly escaped double-quoted JSON string: `figma.showUI("<!DOCTYPE html>\n...")`
- ✅ Node.js syntax check passes
- ✅ No more template literal syntax in the output

The plugin should now load correctly in Figma. The syntax error was caused by nested template literals (the React bundle inside the HTML contains backticks, which broke when wrapped in another template literal by esbuild).

## Final Implementation

The fix is implemented in `scripts/build-plugin.js` lines 53-66:

```javascript
// esbuild converts the string to a template literal (backtick), so look for `, {`
// Also handle potential double-quoted string output
let optionsStart = output.indexOf('`, {', showUIStart);
let closingChar = '`';
if (optionsStart === -1) {
  optionsStart = output.indexOf('", {', showUIStart);
  closingChar = '"';
}
if (optionsStart === -1) return;

// Extract everything before and after the HTML argument
const before = output.substring(0, showUIStart + 'figma.showUI('.length);
// Skip the closing quote/backtick, keep the ", {" part
const after = output.substring(optionsStart + 1);

// Replace the HTML argument with a properly escaped single-line JSON string
const escapedHtml = JSON.stringify(htmlContent);
output = before + escapedHtml + after;
```

This ensures that regardless of whether esbuild outputs a template literal or double-quoted string, the post-processing correctly replaces it with a properly escaped JSON string.

## Current State Verification

Run these commands to verify the current state:

```bash
# Check the actual output around the problematic line
sed -n '670,680p' dist/main.js

# Check if figma.showUI uses template literal or string
grep -n "figma.showUI" dist/main.js | head -1

# Syntax check (passes but Figma still fails)
node --check dist/main.js
```

**Current Output (Line 673):**

```
figma.showUI(`<!DOCTYPE html>
```

**Expected Output:**

```
figma.showUI("<!DOCTYPE html>\n<html lang=\"en\">...
```

## Build Commands

- `pnpm build` - Builds both UI and plugin
- `pnpm dev` - Watch mode for development
- `node --check dist/main.js` - Syntax check (currently passes, but Figma fails)
