name: GitHub Action Test
run-name: "GitHub Action Test: ${{ github.event.client_payload.title || 'Dispatched from Figma' }}"

on:
  # Triggered via repository_dispatch from CI workflow or Figma plugin
  repository_dispatch:
    types: [test-action, figma-variables-update]

# Permissions needed for the action
permissions:
  contents: read

jobs:
  test:
    name: Run Action (Dry Run)
    runs-on: ubuntu-latest
    steps:
      - name: Determine ref
        id: config
        env:
          PAYLOAD_REF: ${{ github.event.client_payload.ref }}
          DEFAULT_REF: ${{ github.sha }}
        run: |
          REF="${PAYLOAD_REF:-$DEFAULT_REF}"
          echo "ref=$REF" >> "$GITHUB_OUTPUT"
          echo "Testing ref: $REF"

      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.config.outputs.ref }}

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - run: pnpm install --frozen-lockfile

      - name: Build action
        run: pnpm --filter @figma-vex/action build

      - name: Run Figma VEX Action (dry-run)
        id: run-action
        uses: ./
        with:
          dry-run: true
          token: ${{ secrets.GITHUB_TOKEN }}
          base-branch: main
          pr-title: 'test: update design tokens (automated test)'
          css-path: 'test-output/tokens.css'
          json-path: 'test-output/tokens.json'
          typescript-path: 'test-output/tokens.ts'

      - name: Summary
        env:
          REF: ${{ steps.config.outputs.ref }}
        run: |
          {
            echo "## Dry-Run Test Results"
            echo ""
            echo "Tested ref: \`$REF\`"
            echo ""
            echo "The action ran in dry-run mode and previewed the following changes:"
            echo ""
            echo "- **PR Title:** test: update design tokens (automated test)"
            echo "- **Files that would be written:**"
            echo "  - test-output/tokens.css"
            echo "  - test-output/tokens.json"
            echo "  - test-output/tokens.ts"
            echo ""
            echo "See the action logs above for the full file contents and PR description."
            echo ""
            echo "âœ… Dry-run completed successfully - no changes were made"
          } >> "$GITHUB_STEP_SUMMARY"
