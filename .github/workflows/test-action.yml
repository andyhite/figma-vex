name: GitHub Action Test
run-name: "GitHub Action Test: ${{ github.event.client_payload.title || 'Dispatched from Figma' }}"

on:
  # Triggered via repository_dispatch from CI workflow or Figma plugin
  repository_dispatch:
    types: [test-action, figma-variables-update]

# Permissions needed for the action
permissions:
  contents: read

jobs:
  test:
    name: Run Action (Dry Run)
    runs-on: ubuntu-latest
    steps:
      - name: Determine ref
        id: config
        env:
          PAYLOAD_REF: ${{ github.event.client_payload.ref }}
          DEFAULT_REF: ${{ github.sha }}
        run: |
          REF="${PAYLOAD_REF:-$DEFAULT_REF}"
          echo "ref=$REF" >> "$GITHUB_OUTPUT"
          echo "Testing ref: $REF"

      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.config.outputs.ref }}

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - run: pnpm install --frozen-lockfile

      - name: Build action
        run: pnpm --filter @figma-vex/action build

      - name: Run Figma VEX Action (dry-run)
        id: run-action
        uses: ./
        with:
          dry-run: true
          token: ${{ secrets.GITHUB_TOKEN }}
          base-branch: main
          pr-title: 'test: update design tokens (automated test)'
          css-path: 'test-output/tokens.css'
          json-path: 'test-output/tokens.json'
          typescript-path: 'test-output/tokens.ts'

      - name: Generate output files
        run: |
          mkdir -p test-output
          # Copy event payload for debugging (the full payload is at $GITHUB_EVENT_PATH)
          cp "$GITHUB_EVENT_PATH" test-output/event.json
          pnpm dlx tsx -e "
            import { convertToCss, convertToTypeScript } from './packages/shared/src/index.ts';
            import * as fs from 'fs';

            // Read from the event file that GitHub Actions provides
            const eventPath = process.env.GITHUB_EVENT_PATH;
            const eventText = fs.readFileSync(eventPath, 'utf8');
            const event = JSON.parse(eventText);
            const payload = event.client_payload;

            if (!payload) {
              console.error('No client_payload found in event');
              console.error('Event keys:', Object.keys(event));
              process.exit(1);
            }

            const document = payload.document;
            const settings = payload.settings || { colorFormat: 'hex', defaultUnit: 'px', remBase: 16 };

            console.log('Document collections:', Object.keys(document?.collections || {}));
            console.log('Document styles:', Object.keys(document?.['\$styles'] || {}));
            console.log('Settings:', JSON.stringify(settings, null, 2));

            if (!document) {
              console.error('No document found in payload');
              process.exit(1);
            }

            fs.writeFileSync('test-output/tokens.css', convertToCss(document, settings));
            fs.writeFileSync('test-output/tokens.json', JSON.stringify(document, null, 2));
            fs.writeFileSync('test-output/tokens.ts', convertToTypeScript(document, settings));

            console.log('Generated files:');
            console.log('  - test-output/tokens.css');
            console.log('  - test-output/tokens.json');
            console.log('  - test-output/tokens.ts');
          "

      - name: Upload generated files
        uses: actions/upload-artifact@v4
        with:
          name: generated-tokens
          path: test-output/

      - name: Summary
        env:
          REF: ${{ steps.config.outputs.ref }}
        run: |
          {
            echo "## Dry-Run Test Results"
            echo ""
            echo "Tested ref: \`$REF\`"
            echo ""
            echo "The action ran in dry-run mode and previewed the following changes:"
            echo ""
            echo "- **PR Title:** test: update design tokens (automated test)"
            echo "- **Files that would be written:**"
            echo "  - test-output/tokens.css"
            echo "  - test-output/tokens.json"
            echo "  - test-output/tokens.ts"
            echo ""
            echo "See the action logs above for the full file contents and PR description."
            echo ""
            echo "ðŸ“¦ Generated files are available as build artifacts"
            echo ""
            echo "âœ… Dry-run completed successfully - no changes were made"
          } >> "$GITHUB_STEP_SUMMARY"
